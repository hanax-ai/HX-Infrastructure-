# Engineering Task: Configure Environment Variables for RAG Write Authentication

> **Task ID**: `ENG-004.5`  
> **Priority**: `High`  
> **Assigned To**: `Infrastructure Team`  
> **Due Date**: `2025-08-21`

---

## ðŸŽ¯ Objective

Configure environment variables for RAG write authentication and embedding dimensions, setting up the security foundation for the upsert endpoint.

---

## ðŸ—ï¸ Infrastructure Context

- **Component**: `api-gateway`
- **Service Impact**: `hx-gateway-ml.service (port 4010) - Configuration only`
- **Network Changes**: `No`
- **Rollback Plan**: `Remove added environment variables from /etc/hx/gateway.env`

---

## âš ï¸ Risk Assessment

- **Risk Level**: `Low`
- **Potential Impact**: Configuration changes only, no code modifications
- **Mitigation**: Test environment loading before service restart
- **Dependencies**: ENG-003 (Routes Module) must be completed first

---

## âœ… Execution Plan

### Step 0: Verify Preconditions/Pre-Flight

*Ensure all necessary environment permissions, directories, files, variables, configurations, and database migrations are in place before starting.*

1. **Verify environment directory exists** *(Est: 0.1 hours)*
   - Check `/etc/hx/` directory exists
   - Verify write permissions for configuration files
2. **Backup existing configuration** *(Est: 0.1 hours)*
   - Create backup of current gateway.env if exists
   - Document current environment setup

### Implementation Steps

1. **Create or update gateway environment file** *(Est: 0.2 hours)*

   ```bash
   # Backup existing config
   sudo cp /etc/hx/gateway.env /etc/hx/gateway.env.backup 2>/dev/null || true
   
   # Add RAG configuration (idempotent)
   sudo tee -a /etc/hx/gateway.env >/dev/null <<'ENV'
   EMBEDDING_DIM=1024
   RAG_WRITE_KEY=supersecret          # rotate in prod secrets store
   ENV
   ```

2. **Verify environment file format** *(Est: 0.1 hours)*
   - Check file syntax is correct
   - Verify no duplicate entries
   - Ensure proper permissions are set

3. **Test environment loading** *(Est: 0.1 hours)*
   - Source environment file without errors
   - Verify variables are properly exported
   - Check for any syntax issues

---

## ðŸ§ª Validation Criteria

### Must-Pass Validations

1. **Service Health**: Environment file is properly formatted and loadable
2. **End-to-End**: Variables can be sourced and accessed correctly  
3. **Performance**: No impact on existing configuration
4. **Security**: Proper file permissions for sensitive configuration

### Test Case

- **Description**: Configure environment variables for RAG write authentication
- **Expected Result**: Environment file exists with correct variables and permissions

### Test Steps

1. Verify environment file was created/updated
2. Test file can be sourced without errors
3. Confirm variables are available when sourced
4. Check file permissions are secure

### Test Commands

```bash
# Verify file exists and has content
test -s /etc/hx/gateway.env && echo "âœ… Gateway environment file exists"

# Check for required variables
grep -q "EMBEDDING_DIM=1024" /etc/hx/gateway.env && echo "âœ… EMBEDDING_DIM configured"
grep -q "RAG_WRITE_KEY=" /etc/hx/gateway.env && echo "âœ… RAG_WRITE_KEY configured"

# Test file can be sourced
set -a && source /etc/hx/gateway.env && set +a && echo "âœ… Environment file sources successfully"

# Verify variables are available
source /etc/hx/gateway.env && [[ "$EMBEDDING_DIM" == "1024" ]] && echo "âœ… EMBEDDING_DIM value correct"

# Check file permissions
ls -la /etc/hx/gateway.env | grep -E "^-rw-r--r--" && echo "âœ… File permissions correct"

# Verify no duplicate entries
sort /etc/hx/gateway.env | uniq -d | wc -l | grep -q "^0$" && echo "âœ… No duplicate entries"
```

---

## ðŸ“Š Status Tracking

- **Current Status**: `Not Started`
- **Completion**: `0%`
- **Time Estimated**: `0.5 hours`
- **Time Actual**: `[To be filled]`
- **Last Updated**: `2025-08-21`
- **Blocked By**: `ENG-003 (Routes Module)`

### Change Log

- **2025-08-21**: Task created for environment configuration setup

---

## ðŸ“Ž Additional Information

### Requirements

- ENG-003 (Routes Module) must be completed first
- Proper file permissions and security
- Idempotent configuration updates
- Environment variables ready for service restart

### Notes

- RAG_WRITE_KEY should be rotated in production secrets store
- EMBEDDING_DIM enforces 1024-dimensional vector validation
- Configuration is idempotent and can be re-run safely

---

## ðŸ“š References

- **Related Issues**: RAG Document Upsert Endpoint Implementation
- **Documentation**: Environment configuration for write-scope authentication
- **Architecture Notes**: Security configuration with minimal attack surface
- **Dependencies**: Requires ENG-003 completion, blocks ENG-005 (Service Restart)
